name: Renderer Performance Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # ä¹Ÿå¯ä»¥æ·»åŠ å®šæ—¶è¿è¡Œï¼Œæ¯å‘¨ç›‘æµ‹ä¸€æ¬¡æ€§èƒ½å˜åŒ–
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€è¿è¡Œ

jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      # å®‰è£…Puppeteerå’Œå…¶ä»–éœ€è¦çš„å·¥å…·
      - name: Install test dependencies
        run: npm install --no-save puppeteer
      
      # æ„å»ºé¡¹ç›®  
      - name: Build project
        run: npm run build
      
      # å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨æ¥è¿è¡Œæ„å»ºåçš„é¡¹ç›®
      - name: Start local server
        run: npx serve dist &
        
      # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
      - name: Wait for server
        run: sleep 5
      
      # è¿è¡ŒLighthouseè¿›è¡Œæ€§èƒ½åˆ†æ - æ¡Œé¢ç‰ˆ
      - name: Run Lighthouse - Desktop
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: '.github/workflows/lighthouse-config.json'
          runs: 3  # è¿è¡Œå¤šæ¬¡å–å¹³å‡å€¼ï¼Œæé«˜å‡†ç¡®æ€§
          
      # è¿è¡ŒLighthouseè¿›è¡Œæ€§èƒ½åˆ†æ - ç§»åŠ¨ç‰ˆ
      - name: Run Lighthouse - Mobile
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: '.github/workflows/lighthouse-config.json'
          runs: 3  # è¿è¡Œå¤šæ¬¡å–å¹³å‡å€¼ï¼Œæé«˜å‡†ç¡®æ€§
          emulatedFormFactor: mobile
      
      # æ”¶é›†WebGL/WebGPUæ€§èƒ½æŒ‡æ ‡
      - name: Collect Renderer Performance Metrics
        run: node .github/workflows/collect-renderer-metrics.js
        
      # å°†æ€§èƒ½æŠ¥å‘Šå‘å¸ƒåˆ°PRè¯„è®º
      - name: Add Performance Report to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('./lighthouse-results.json', 'utf8'));
            
            const formatScore = (score) => {
              const scoreNum = Math.round(score * 100);
              let emoji = 'ğŸŸ¢';
              if (scoreNum < 50) emoji = 'ğŸ”´';
              else if (scoreNum < 90) emoji = 'ğŸŸ ';
              return `${emoji} ${scoreNum}`;
            };
            
            let body = `## ğŸš€ Performance Report\n\n`;
            
            // æ·»åŠ æ¸²æŸ“å™¨ä¿¡æ¯
            if (results.renderer) {
              const r = results.renderer;
              body += `### ğŸ® ${r.engine} (${r.rendererType}) Performance\n\n`;
              
              // æ¸²æŸ“å™¨ä¿¡æ¯è¡¨
              body += `#### Renderer Information\n`;
              if (r.rendererInfo && Object.keys(r.rendererInfo).length > 0) {
                body += `| Property | Value |\n`;
                body += `| ------ | ----- |\n`;
                
                for (const [key, value] of Object.entries(r.rendererInfo)) {
                  if (value) {
                    body += `| ${key.charAt(0).toUpperCase() + key.slice(1)} | ${value} |\n`;
                  }
                }
                body += `\n`;
              }
              
              // æ€§èƒ½æŒ‡æ ‡è¡¨
              body += `#### Performance Metrics\n`;
              body += `| Metric | Value |\n`;
              body += `| ------ | ----- |\n`;
              body += `| Average FPS | ${r.avgFps} |\n`;
              body += `| Min FPS | ${r.minFps} |\n`;
              body += `| Draw Calls per Frame | ${r.drawCalls} |\n`;
              body += `| Triangle Count | ${r.triangles} |\n`;
              body += `| Memory Usage | ${r.memoryUsage}MB |\n\n`;
            }
            
            // Web Vitals
            body += `### ğŸ“Š Desktop Web Vitals\n\n`;
            body += `| Metric | Score |\n`;
            body += `| ------ | ----- |\n`;
            body += `| Performance | ${formatScore(results.desktop.performance)} |\n`;
            body += `| First Contentful Paint | ${results.desktop.first_contentful_paint}ms |\n`;
            body += `| Largest Contentful Paint | ${results.desktop.largest_contentful_paint}ms |\n`;
            body += `| Total Blocking Time | ${results.desktop.total_blocking_time}ms |\n`;
            body += `| Cumulative Layout Shift | ${results.desktop.cumulative_layout_shift} |\n\n`;
            
            body += `### ğŸ“± Mobile Web Vitals\n\n`;
            body += `| Metric | Score |\n`;
            body += `| ------ | ----- |\n`;
            body += `| Performance | ${formatScore(results.mobile.performance)} |\n`;
            body += `| First Contentful Paint | ${results.mobile.first_contentful_paint}ms |\n`;
            body += `| Largest Contentful Paint | ${results.mobile.largest_contentful_paint}ms |\n`;
            body += `| Total Blocking Time | ${results.mobile.total_blocking_time}ms |\n`;
            body += `| Cumulative Layout Shift | ${results.mobile.cumulative_layout_shift} |\n\n`;
            
            // ä¼˜åŒ–å»ºè®®
            let suggestions = [];
            
            // åŸºäºFPSæä¾›å»ºè®®
            if (results.renderer && parseFloat(results.renderer.avgFps) < 50) {
              suggestions.push('- Consider reducing geometry complexity or optimizing shaders to improve FPS');
            }
            
            // åŸºäºç»˜åˆ¶è°ƒç”¨æä¾›å»ºè®®
            if (results.renderer && results.renderer.drawCalls > 1000) {
              suggestions.push('- High number of draw calls detected. Consider using geometry instancing or merging geometries');
            }
            
            // åŸºäºä¸‰è§’å½¢æ•°é‡æä¾›å»ºè®®
            if (results.renderer && results.renderer.triangles > 1000000) {
              suggestions.push('- Very high triangle count. Consider using LOD (Level of Detail) for complex models');
            }
            
            // åŸºäºå†…å­˜ä½¿ç”¨æä¾›å»ºè®®
            if (results.renderer && results.renderer.memoryUsage > 200) {
              suggestions.push('- High memory usage. Consider optimizing textures and assets');
            }
            
            // é’ˆå¯¹WebGPUçš„å»ºè®®
            if (results.renderer && results.renderer.rendererType === 'webgpu') {
              suggestions.push('- For WebGPU performance, ensure you\'re using modern rendering patterns like instanced rendering and compute shaders');
              suggestions.push('- Consider implementing frame graph architecture for optimal GPU resource management');
            }
            
            // è¾“å‡ºä¼˜åŒ–å»ºè®®
            if (suggestions.length > 0) {
              body += `### ğŸ’¡ Optimization Suggestions\n\n`;
              suggestions.forEach(suggestion => {
                body += `${suggestion}\n`;
              });
              body += `\n`;
            }
            
            body += `[ğŸ“‹ Full Report](${results.reportUrl})\n\n`;
            body += `<details><summary>ğŸ“ˆ Performance Trends</summary>\n\n`;
            body += `![Performance Trend](${results.performanceTrendUrl})\n\n`;
            body += `</details>\n\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });